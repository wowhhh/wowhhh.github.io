---
layout: post
title:  "DNS详解"
tags:   应用层 DNS 
date:   2020-05-09 20:34:20 +0800
categories: [计算机网络]

---

## 

- **参考资料**
  - 1：《计算机网络自顶向下方法》
  - 2：[一篇你看了就懂的DNS详解](https://www.cnblogs.com/anyhoo/p/10369589.html)（关于请求转发讨论的描述很详细！）
  - 3：[关与DNS本地化的意义和实现](http://blog.chinaunix.net/uid-401789-id-2407919.html)
- 思维脉络图

![](https://i.loli.net/2020/09/01/JAn8ra1w2jgz5sU.png)

### 说在前面

- 主机的标识方法

  - 1：域名

    等级的划分：从右向左划分等级，最右边的是最高级的根域，根域即`.`，但是在平时的使用时候，后面一般不加`.`，比如：`www.baidu.com	::	www.baidu.com.`

    区分等级域：看域名里面有几个点

    |        .        |    根域名     |
    | :-------------: | :-----------: |
    |    baidu.com    | 顶级域/一级域 |
    |  map.baidu.com  |    二级域     |
    | a.map.baidu.com |    三级域     |

    主机名没有提供关于主机在因特网中位置的信息。

    主机名由不定长的字母和数字组成，路由器比较难处理。

  - 2：IP地址

    计算机在网络通讯上面只能识别IP地址

    不好记忆

    eg : 219.216.64.227

## DNS是什么

- DNS(Domain Name System) 即 域名系统

- 一个由分层的DNS服务器实现的 **分布式** 数据库（用于域名和IP地址映射）
- 一个使得主机能够查询分布式数据库的应用层协议

## DNS提供的服务

- DNS即域名系统(Domain Name System，DNS)，提供能够进行主机名到IP地址转换的目录服务，即将主机名转换为背后的IP地址。

- DNS协议运行在UDP之上，使用53号端口



#### 举个栗子

- 下面例子是HTTP客户请求某个页面(www.github.com/wowhhh)的时候的运行过程。
  - 有言在先：要使得HTTP客户的请求报文能够发送到服务器上面，就必须得指定服务器的IP地址(www.github.com)
  - 1：浏览器从上述URL中抽取出来主机名(www.github.com)，并将这台主机名传给DNS应用的客户端（也就是用户主机上面运行着的DNS应用的客户端）
  - 2：DNS客户端向DNS服务器发送一个包含主机名的请求
  - 3：DNS客户最终会收到一份回答报文，其中含有对应与该主机名的IP地址。
  - 4：浏览器得到了此IP地址之后，就可以建立位于该IP地址80端口的HTTP服务器建立一个TCP连接。

#### DNS提供的其他服务

- 主机别名

  主机的名字不止一个，如果太复杂，也可以存在简单的别名

- 邮件服务器别名

- 负载分配



## DNS工作原理概述

- 如果整个网络只有一个DNS服务器会导致什么后果？

  **单点故障**

  **通信容量**

  **远距离**

  **维护**

为了解决上述问题，提出了分层，分布式的DNS服务器以及DNS缓存的机制：

#### 分层、分布式的DNS服务器

前面已经对域名的等级有了一部分的了解，而每一层的DNS服务器存储的都是对应等级的域名。所以DNS的服务器类型大概三种类型：根DNS服务器、顶级域DNS服务器和权威DNS服务器。

- 根DNS服务器

  根服务器提供顶级域DNS服务器的IP地址

- 顶级域DNS服务器

  `eg:com、org、net、edu、gov`

  提供权威DNS服务器的IP地址

- 权威DNS服务器

  组织机构所提供的，比如说百度提供访问到它主机资源的记录，这些记录会将这些主机（组织提供的）的名字映射为IP地址。

三者为层次结构：

![](https://i.loli.net/2020/09/01/rPLMfvi6dCx19lE.png)

除了上述之外，还有**本地DNS服务器**

#### 本地DNS

- 做什么用的？

  从上面的讨论可以看出来，每一位用户访问域名，DNS都要提供解析，这可能会导致DNS服务器的负载增大，被大流量的访问压垮，所以讲DNS服务器本地化，也就是用户访问某个域名的时候，首先访问的是自己本地DNS服务器，这样就会缓解上述问题。

  相当于一个代理的DNS解析服务器。

- 如何设置的？

  1：如果你的电脑是直连运营商（ISP）网络，一般默认设置情况下DNS为ISP的服务器地址。

  2：如果你的电脑和ISP之间还加了无线或者有线路由（一般的路由器本身还会内置DNS转发器），它的作用是将发往它所有的DNS请求转发到上层DNS，但最终会转发到ISP的DNS。

  ![](https://i.loli.net/2020/09/01/oa1rFQVARhB9KPm.png)

#### DNS解析流程

1：在我电脑的浏览器中输入[www.baidu.com](http://www.baidu.com/)域名，浏览器会从**浏览器的DNS缓存**中检查是否有这个网址的映射关系，如果有，就返回IP，完成域名解析。

2：如果没有，操作系统会先检查自己本地的**hosts文件**是否有这个网址的映射关系，如果有，就返回IP，完成域名解析。关于缓存，下面有单独对缓存的讨论

3：如果还没有，我的电脑就要向本地DNS服务器发起请求查询[www.baidu.com](http://www.baidu.com/)这个域名。

4：本地DNS服务器拿到请求后，先检查一下自己的缓存（**本地DNS服务器缓存**）中有没有这个地址，有的话直接返回。这个时候拿到的IP地址，会被标记为非权威服务器的应答（因为是本地DNS服务器返回的）

5：如果本地DNS服务器的缓存中没有的话，本地DNS服务器会从配置文件中读取**根DNS服务器**的地址，然后向其中一台发起请求

6：根DNS服务器拿到请求后，知道他是**com.**这个顶级域名下的，所以会返回com域名中的NS记录（用来表明哪台服务器对该域名进行解析），其实就是一个IP（com对应的服务器IP）

7：本地DNS服务器根据返回的IP（com DNS服务器）发起请求，com DNS服务器（**顶级域服务器**）发现你这请求的是baidu.com这个域，查到这个域的NS记录，然后返回IP（baidu.com）

8：本地DNS服务器在根据IP（baidu.com DNS服务器）访问这些权威服务器，baidu.com服务器在A记录（正向解析记录，域名到IP地址的映射）中查找到www.baidu.com的IP地址，返回IP（[www.baidu.com](http://www.baidu.com/)）。

9：最终本地DNS服务器拿到用户想访问的[www.baidu.com](http://www.baidu.com/)的IP，返回给客户端，并进行缓存操作，以便下次使用。



上述描述的流程，是简化了许多的流程，因为顶级域服务器一般不是直接知道权威服务器的IP的，里面可能要经历多个转发过程，那这里面就涉及到了**递归查询**和**迭代查询**

​	我所理解的递归查询就是我发送出去信息，再接收回来就完事了；迭代查询就是，我发送出去信息，想接收最终的结果，但是会返回我中间结果，我需要使用中间结果继续发送查询信息。

​	通常情况下：1：我的电脑到本地DNS服务器的查询是递归的；2：其余的是迭代的，即本地DNS到其他DNS服务器。

#### DNS缓存

改善时延，浏览器，host文件，本地DNS服务器以及其他DNS服务器都会缓存之前请求得到过的记录，但是这些记录并不是永久的，DNS服务器会在一段时间后丢弃缓存的信息。



## DNS的记录和报文

我们称提供主机名到IP地址映射关系的记录为**资源记录**(Resource Record)，每一个DNS的回答报文包含了一条或者多条资源记录。

资源记录是包含了以下字段的4元组：

`(Name, Value, Type, TTL)`

下面对上面的四个元素讨论里面的值：

- TTL

  表示该记录的生存时间，决定了资源记录应当从缓存中删除的时间。

- Type

  之所以先讨论Type是因为Name和Value的值取决于Type

  - `Type = A`

    Name表示主机名，Value是该主机名对应的IP地址；例如`(relay1.bar.foo.com,145.37.93.126,A,TTL)`

  - `Type = NS`

    Name表示域(`baidu.com`),Value是知道如何获得该域主机IP地址的权威服务器的主机名。例如`(baidu.com,map.baidu.com)`

  - `Type = CNAME`

    Name表示主机的别名，Value表示规范名

  - `Type = MX`

    Value是个别名为Name的邮件服务器的规范主机名。