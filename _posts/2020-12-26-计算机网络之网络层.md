---
layout: post
title:  "网络层，看这一篇就够了"
tags:   网络层 子网掩码
date:   2020-12-26 11:30:00 +0800
categories: [计算机网络]

---



## 网络层概述

网络层的目的是实现两端系统之间的数据透明传送，具体功能包括寻址和路由选择、连接的建立、保持和终止等。它提供的服务使传输层不需要了解网络中的数据传输和交换技术。用少量的词来记忆网络层，那就是 “路径选择，路由及逻辑寻址”。

网络层涉及众多的协议，其中包括最重要的协议，也是 TCP/IP 的核心协议 ——**IP** 协议。IP 协议仅仅提供不可靠、无连接的传送服务。IP 协议的主要功能有：无连接数据报传输、数据报路由选择和差错控制。与 IP 协议配套使用实现其功能的还有地址解析协议 **ARP**、逆地址解析协议 **RARP**、因特网报文协议 **ICMP**、因特网组管理协议 **IGMP**。

### 重点

- 网络层负责对子网间地数据包进行路由选择。此外，网络层还可以实现拥塞控制、网际互联等功能
- 基本数据单位为 **IP 数据报**
- 包含的主要协议：
  - Internet Protocol（因特网互联协议）
  - Internet Control Message Protocol（因特网控制报文协议）
  - Address Resolution Protocol（地址解析协议）
  - Reverse Address Resolution Protocol（逆地址解析协议）
- 重要地设备：**路由器**

## 网络层术语概括

1. **虚电路（Virtual Circuit）** : 在两个终端设备的逻辑或物理端口之间，通过建立的双向的透明传输通道。虚电路表示这只是一条逻辑上的连接，分组都沿着这条逻辑连接按照存储转发方式传送，而并不是真正建立了一条物理连接。

   如下图所示，主机H1和H2之间交换的分组都必须在事先建立的虚电路上传送：

   ![image-20201226152750220](https://raw.githubusercontent.com/ARP2019/ImageUpload/master/img/2020-12-12/image-20201226152750220.png)

   虚电路的设计是为了使网络层提供可靠交付，但是目前的网络层设计提供的不可靠的交付，也就是虚电路并没有采用。

   这是因为：虚电路增加了中间设备的成本，同时依旧对传输层存在依赖性，很明显，假设虚电路断了，主机之间就无法访问了。

2. **数据报**：网络层向上只提供简单灵活的、无连接的、进最大努力交付的数据报服务。网络在发送分组时不需要先建立连接。每一个分组（一个 IP 数据报）独立发送，与其前后的分组无关（不进行编号）。**网络层不提供服务质量的承诺**。这样，所传送的分组可能出错、丢失、重复和失序（即不按发送顺序到达终点），当然也不保证交付的时限。

   IP 数据报分为首部和数据两部分。

   首部的前一部分是固定长度，共 20 字节，是所有 IP 数据包必须具有的（源地址，目的地址，总长度等重要地段都固定在首部）。

   一些长度可变的可选字段固定在首部的后面。IP 首部中的生存时间给出了 IP 数据报在互联网中所能经过的最大路由器数。可防止 IP 数据报在互联网中无限制的兜圈子。

   如下图，主机H1向主机H2发送的分组各自独立地选择路由，并且在传送过程中可能会存在丢失：

   ![image-20201226153203074](https://raw.githubusercontent.com/ARP2019/ImageUpload/master/img/2020-12-12/image-20201226153203074.png)

3. **IP（Internet Protocol ）** : 网际协议 IP 是 TCP/IP 体系中两个最主要的协议之一，是 TCP/IP 体系结构网际层的核心。配套的有 ARP，RARP，ICMP，IGMP。IP 地址就是给因特网上的每一台主机（或路由器）的**每一个接口**分配一个在全世界范围是唯一的 32 位的标识符。

4. **ARP（Address Resolution Protocol）** : 地址解析协议。地址解析协议 ARP 把 IP 地址解析为硬件地址。

5. **ICMP（Internet Control Message Protocol ）** ：网际控制报文协议 （ICMP 允许主机或路由器报告差错情况和提供有关异常情况的报告）。

6. **子网掩码（subnet mask ）** ：它是一种用来指明一个 IP 地址的哪些位标识的是主机所在的子网以及哪些位标识的是主机的位掩码。子网掩码不能单独存在，它必须结合 IP 地址一起使用。**子网掩码只有一个作用，就是将某个 IP 地址划分成网络地址和主机地址两部分。**

   ![image-20201226155109476](https://raw.githubusercontent.com/ARP2019/ImageUpload/master/img/2020-12-12/image-20201226155109476.png)

7. **CIDR（ Classless Inter-Domain Routing ）**：无分类域间路由选择 （特点是消除了传统的 A 类、B 类和 C 类地址以及划分子网的概念，并使用各种长度的“网络前缀”(network-prefix)来代替分类地址中的网络号和子网号）。

8. **默认路由（default route）** ：当在路由表中查不到能到达目的地址的路由时，路由器选择的路由。默认路由还可以减小路由表所占用的空间和搜索路由表所用的时间。

9. **路由选择算法（Virtual Circuit）** ：路由选择协议的核心部分。因特网采用自适应的，分层次的路由选择协议。

## 重要知识点详解

#### 0：IP数据包的格式：

![image-20201226164916730](https://raw.githubusercontent.com/ARP2019/ImageUpload/master/img/2020-12-12/image-20201226164916730.png)

[网络层（九）IP 数据报的格式](https://wmathor.com/index.php/archives/1131/)

#### 1：网络层提供的服务

负责在不用网络之间尽力转发数据包，基于数据包的IP转发。

**TCP/IP 协议中的网络层向上只提供简单灵活的，无连接的，尽最大努力交付的数据报服务。**

**网络层不提供服务质量的承诺，不保证分组交付的时限所传送的分组可能出错，丢失，重复和失序，尽力而为的服务。**

**进程之间通信的可靠性由运输层负责。**如果某个数据包出错了，传输层会让网络层再发一遍。

在互联网的交付有两种，一是在本网络直接交付不用经过路由器，另一种是和其他网络的间接交付，至少经过一个路由器，但最后一次一定是直接交付。

#### 2：分类的IP地址

Ip地址就是给因特网上的每一个主机或者路由器的每一个端口分配一个唯一的32位标识符。IP地址的编制方法经历了三个阶段：

1.分类的IP地址

2.子网划分

3.构成超网

- 分类的 IP 地址由网络号字段（指明网络）和主机号字段（指明主机）组成。

  网络号字段最前面的类别指明 IP 地址的类别。IP 地址是一种分等级的地址结构。IP 地址管理机构分配 IP 地址时只分配网络号，主机号由得到该网络号的单位自行分配。

  **分类IP地址有什么用呢？**

  看下图：

  ![image-20201226154526523](https://raw.githubusercontent.com/ARP2019/ImageUpload/master/img/2020-12-12/image-20201226154526523.png)

  假设当前有一个数据包的目的地址是```192.168.3.0```,路由器接收到数据包，只要看到192.168.3，就会往指定的网段发送，所以说路由器只关心如何将数据包送到某一个网段。

  当一个主机同时连接到两个网络上时，该主机就必须同时具有两个相应的 IP 地址，其网络号 net-id 必须是不同的。这种主机称为多归属主机 (multihomed host)
  由于一个路由器至少应当连接到两个网络（这样它才能将 IP 数据报从一个网络转发到另一个网络），因此**一个路由器至少应当有两个不同的 IP 地址**
  
- IP地址的分类

  如下图：

  ![image-20201226164249196](https://raw.githubusercontent.com/ARP2019/ImageUpload/master/img/2020-12-12/image-20201226164249196.png)

  A、B、C分类为常用的分类，他们的适用范围是：

  ![image-20201226164349280](https://raw.githubusercontent.com/ARP2019/ImageUpload/master/img/2020-12-12/image-20201226164349280.png)

#### 3：划分子网

- 划分子网

  前面讲到的两级IP地址，由网络号与主机号组成。两级IP地址的设计不合理：

  -  IP地空间利用率低
  -  给每一个物理网络分配一个网络号会使路由表变得太大而是网络性能变坏
  -  两级IP 地址不够灵活

  为解决这些问题，后再IP地址中添加一个“子网号字段”，使两级IP地址变成三级IP地址，能较好的解决上述问题，并且使用灵活。---- 即**划分子网**。

  那么IP地址的格式就变成了： IP地址 ::= { <网络号> ,<子网号> ,<主机号>}

  看下面图片 的例子：

  ![image-20201226165313801](https://raw.githubusercontent.com/ARP2019/ImageUpload/master/img/2020-12-12/image-20201226165313801.png)

- 子网掩码的所用

  - 为什么使用子网掩码？

    因为从一个 IP 数据报的首部并无法判断源主机或目的主机所连接的网络是否进行了子网划分。使用子网掩码(subnet mask)可以找出 IP 地址中的子网部分

  - **计算某IP地址所在的网段**

  ![image-20201226155253795](https://raw.githubusercontent.com/ARP2019/ImageUpload/master/img/2020-12-12/image-20201226155253795.png)

  - **当不划分子网时，为什么还要使用子网掩码**

    这是为了便于路由器查找路由表。现在互联网的标准规定：所有的网络都必须使用子网掩码，同时在路由器的路由表中也必须有子网掩码这一栏。**如果一个网络不划分子网，那么该网络的子网掩码就使用默认的子网掩码**

#### 4：构成超网

**无分类域间路由选择** CIDR 是解决目前 IP 地址紧缺的一个好办法。因为之前A、B、C类的IP网络号划分不够精细，存在很大程度上的浪费。

- CIDR的特点

  - **CIDR 消除了传统的 A 类、B 类和 C 类地址及划分子网的概念**，因此可以更加有效地分配 IPv4 的地址空间，并且在新的 IPv6 使用前容许因特网的规模继续增长

    >CIDR 把 32 位的 IP 地址划分为两个部分，前面的部分是网络前缀，用来指明网络，后面的部分则用来指明主机，其与分类编址最大的不同，便是网络前缀不局限于 8 的倍数。因此 CIDR 使 IP 地址从三级编址（使用子网掩码）又回到两级地址，但这已经是无分类的两级编址。CIDR 在 IP 地址后面加上斜线 “/”，然后写上网络前缀所占的位数。
    >IP 地址 :: = {<网络前缀>，< 主机号 >}

  - **CIDR 把网络前缀都相同的连续 IP 地址组成一个 “CIDR 地址块”。**我们只要知道 CIDR 地址块中的任何一个地址，就可以知道这个地址块的起始地址（最小地址）和终止地址（最大地址），以及地址块中的地址数

    >例如，已知 IP 地址为 128.14.35.7/20 是某 CIDR 地址块中的一个地址，现在把它写成二进制形式，其中前 20 位是网络前缀，而后面的 12 位是主机号：
    >128.14.35.7/20 = 10000000 00001110 00100011 00000111
    >这个地址块的最小地址为：10000000 00001110 00100000 00000000
    >这个地址块的最大地址为：10000000 00001110 00101111 11111111



#### 5：地址解析协议ARP

IP地址与硬件地址的关系：

![image-20201226164632971](https://raw.githubusercontent.com/ARP2019/ImageUpload/master/img/2020-12-12/image-20201226164632971.png)

- **地址解析协议 ARP 把 IP 地址解析为硬件地址。**

  在**主机 ARP 高速缓存中存放一个从 IP 地址到硬件地址的映射表**，并且这个映射表还经常动态更新（新增或者超时删除）。

  ARP 的高速缓存可以大大减少网络上的通信量。因为这样可以使主机下次再与同样地址的主机通信时，可以直接从高速缓存中找到所需要的硬件地址而不需要再去广播方式发送 ARP 请求分组。

#### 6：网际控制报文协议

为了更有效的转发IP数据报和提高交付成功的机会，在网际层中使用**网际控制报文协议ICMP**它允许主机或路由器报告差错情况和提供有关异常的报告。

- 网际控制报文协议是 IP 层的协议。

  ICMP 报文作为 IP 数据报的数据，加上首部后组成 IP 数据报发送出去。

  使用 ICMP 数据报并不是为了实现可靠传输。

  ICMP 允许主机或路由器报告差错情况和提供有关异常情况的报告。

  ICMP 报文的种类有两种 ICMP 差错报告报文和 ICMP 询问报文。

#### 7：其他重要点

4. **要解决 IP 地址耗尽的问题，最根本的办法是采用具有更大地址空间的新版本 IP 协议-IPv6。** IPv6 所带来的变化有 ① 更大的地址空间（采用 128 位地址）② 灵活的首部格式 ③ 改进的选项 ④ 支持即插即用 ⑤ 支持资源的预分配 ⑥IPv6 的首部改为 8 字节对齐。

5. **虚拟专用网络 VPN 利用公用的互联网作为本机构专用网之间的通信载体。VPN 内使用互联网的专用地址。一个 VPN 至少要有一个路由器具有合法的全球 IP 地址，这样才能和本系统的另一个 VPN 通过互联网进行通信。所有通过互联网传送的数据都需要加密。**

6. MPLS 的特点是：① 支持面向连接的服务质量 ② 支持流量工程，平衡网络负载 ③ 有效的支持虚拟专用网 VPN。MPLS 在入口节点给每一个 IP 数据报打上固定长度的“标记”，然后根据标记在第二层（链路层）用硬件进行转发（在标记交换路由器中进行标记交换），因而转发速率大大加快。

## 参考文章

https://mp.weixin.qq.com/s/i1NXi6xJmrVdGTPCcd-aQg

[wmathor_计算机网络笔记](https://wmathor.com/index.php/category/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/)

[JavaGuide](https://snailclimb.gitee.io/javaguide/#/docs/network/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93?id=_42-%e9%87%8d%e8%a6%81%e7%9f%a5%e8%af%86%e7%82%b9%e6%80%bb%e7%bb%93)

http://www.blogjava.net/jb2011/archive/2019/12/01/434941.html

https://blog.csdn.net/qq_41257129/article/details/93341136